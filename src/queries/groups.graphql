# Fragments

fragment GroupMemberCard on group_members {
    id
    role
    created_at
    user {
        ...UserCard
    }
}

fragment GroupCard on groups {
    id
    name
    created_at
    description
    public

    memberships_aggregate {
        aggregate {
            count
        }
    }
}

fragment GroupDetails on groups {
    ...GroupCard

    memberships {
        ...GroupMemberCard
    }
}

fragment GroupJoinRequestCard on group_join_requests {
    id
    created_at
    updated_at
    status
    group_id
    message

    user {
        ...UserCard
    }
}

fragment GroupJoinTokenCard on group_join_tokens {
    id
    created_at
    updated_at
    token
    disabled
    note
}

# Queries

query ListGroups($limit: Int!, $offset: Int!, $orderBy: groups_order_by!, $where: groups_bool_exp) {
    groups_aggregate(where: $where) {
        aggregate {
            count
        }
    }

    groups(limit: $limit, offset: $offset, where: $where, order_by: [$orderBy]) {
        ...GroupCard
    }
}

query GroupDetails($id: uuid!) {
    groups_by_pk(id: $id) {
        ...GroupDetails
    }
}

query GroupJoinRequests($where: group_join_requests_bool_exp!) {
    group_join_requests(where: $where) {
        ...GroupJoinRequestCard
    }
}

query GroupJoinTokens($where: group_join_tokens_bool_exp!) {
    group_join_tokens(where: $where) {
        ...GroupJoinTokenCard
    }
}

# Mutations

mutation CreateGroup($input: CreateGroupInput!) {
    createGroup(input: $input) {
        group {
            ...GroupCard
        }
    }
}

mutation DeleteGroup($id: uuid!) {
    delete_groups_by_pk(id: $id) {
        ...GroupCard
    }
}

mutation LeaveGroup($groupId: uuid!, $userId: uuid!) {
    delete_group_members(where: { group_id: { _eq: $groupId }, user_id: { _eq: $userId } }) {
        affected_rows
    }
}

mutation JoinGroup($groupId: uuid!) {
    insert_group_members_one(object: { group_id: $groupId }) {
        ...GroupMemberCard
        user {
            ...UserPrivateDetail
        }
    }
}

mutation JoinGroupWithToken($input: JoinGroupInput!) {
    joinGroup(input: $input) {
        group {
            id
        }

        user {
            ...UserPrivateDetail
        }
    }
}

mutation RequestJoinGroup($input: RequestJoinGroupInput!) {
    requestJoinGroup(input: $input) {
        group {
            ...GroupCard
        }

        user {
            ...UserJoinRequests
        }
    }
}

mutation CancelJoinRequest($requestId: uuid!) {
    delete_group_join_requests(where: { id: { _eq: $requestId } }) {
        returning {
            user {
                ...UserJoinRequests
            }
        }
    }
}

mutation HandleJoinRequest($input: HandleJoinRequestInput!) {
    handleJoinRequest(input: $input) {
        join_request {
            ...GroupJoinRequestCard
        }
    }
}

mutation CreateJoinToken($input: group_join_tokens_insert_input!) {
    insert_group_join_tokens_one(object: $input) {
        ...GroupJoinTokenCard
    }
}

mutation DeleteJoinToken($id: uuid!) {
    delete_group_join_tokens_by_pk(id: $id) {
        ...GroupJoinTokenCard
    }
}

mutation UpdateJoinToken($id: uuid!, $input: group_join_tokens_set_input!) {
    update_group_join_tokens_by_pk(pk_columns: { id: $id }, _set: $input) {
        ...GroupJoinTokenCard
    }
}
