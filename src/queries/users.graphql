# Fragments

fragment UserCard on users {
    id
    name
    image
}

fragment UserDetail on users {
    ...UserCard
    created_at
}

fragment UserJoinRequests on users {
    id
    group_join_requests(where: { status: { _eq: pending } }) {
        ...GroupJoinRequestCard
    }
}

fragment UserPrivateDetail on users {
    ...UserDetail
    ...UserJoinRequests

    memberships {
        id
        role
        group {
            ...GroupCard
        }
    }

    private_info {
        email
    }
}

fragment EntityCard on entities {
    id
    group {
        id
        short_id
        name
    }
    thing {
        id
        short_id
        name
        images(limit: 1) {
            file {
                url
            }
        }
    }
    user {
        id
        name
    }
    group_join_request {
        id
        response
    }
}

fragment ActivityCard on activities {
    id
    created_at
    verb
    entity {
        ...EntityCard
    }
    secondary_entity {
        ...EntityCard
    }
    actor {
        ...UserCard
    }
}

fragment NotificationCard on notifications {
    id
    read_at
    created_at
    activity {
        ...ActivityCard
    }
}

# Queries

query UserList($where: users_bool_exp, $limit: Int, $offset: Int) {
    users(where: $where, limit: $limit, offset: $offset) {
        ...UserCard
    }

    users_aggregate(where: $where, limit: 10) {
        aggregate {
            count
        }
    }
}

query UserPrivateDetails($id: uuid!) {
    users_by_pk(id: $id) {
        ...UserPrivateDetail
    }
}

# Subscriptions
subscription Notifications($userId: uuid!) {
    notifications(
        limit: 50
        order_by: [{ created_at: desc }]
        where: { user_id: { _eq: $userId } }
    ) {
        ...NotificationCard
    }
}

# Mutations

mutation MarkNotificationRead($id: uuid!, $readAt: timestamptz!) {
    update_notifications_by_pk(pk_columns: { id: $id }, _set: { read_at: $readAt }) {
        ...NotificationCard
    }
}

mutation MarkAllNotificationsRead($userId: uuid!, $readAt: timestamptz!) {
    update_notifications(
        where: { user_id: { _eq: $userId }, read_at: { _is_null: true } }
        _set: { read_at: $readAt }
    ) {
        affected_rows
        returning {
            ...NotificationCard
        }
    }
}

mutation RegisterUser($input: CredentialsInput!) {
    registerCredentials(input: $input) {
        user {
            ...UserCard
        }
    }
}
